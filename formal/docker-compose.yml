version: '3.8'

services:
  # Main verification service
  verify:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - ./:/workspace
    working_dir: /workspace
    command: verify-all
    environment:
      - TLA_JAR=/opt/tla/tla2tools.jar
      - ALLOY_JAR=/opt/alloy/alloy.jar

  # Interactive shell for debugging
  shell:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - ./:/workspace
    working_dir: /workspace
    command: bash
    stdin_open: true
    tty: true


  # Alloy only (for Alloy development)
  alloy:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - ./:/workspace
    working_dir: /workspace
    command: java -jar /opt/alloy/alloy.jar exec --command 0 --output - shirushi.als
      - ALLOY_JAR=/opt/alloy/alloy.jar

  # TLC only
  tlc:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - ./:/workspace
    working_dir: /workspace
    command: java -jar /opt/tla/tla2tools.jar -config shirushi.cfg shirushi.tla
    environment:
      - TLA_JAR=/opt/tla/tla2tools.jar

# Usage:
#
# Run full verification:
#   docker-compose run --rm verify
#
# Interactive shell:
#   docker-compose run --rm shell
#

#
# Alloy only:
#   docker-compose run --rm alloy
#
# Build images:
#   docker-compose build
