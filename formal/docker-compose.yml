version: '3.8'

services:
  # Main verification service
  verify:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - ./:/workspace
    working_dir: /workspace
    command: verify-all
    environment:
      - APALACHE_CMD=apalache-mc
      - ALLOY_CLI_JAR=/opt/alloy/alloy-cli.jar

  # Interactive shell for debugging
  shell:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - ./:/workspace
    working_dir: /workspace
    command: bash
    stdin_open: true
    tty: true
    environment:
      - APALACHE_CMD=apalache-mc
      - ALLOY_CLI_JAR=/opt/alloy/alloy-cli.jar

  # Apalache only (faster for TLA+ development)
  apalache:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - ./:/workspace
    working_dir: /workspace
    command: apalache-mc check --config=apalache.cfg shirushi.tla
    environment:
      - APALACHE_CMD=apalache-mc

  # Alloy only (for Alloy development)
  alloy:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - ./:/workspace
    working_dir: /workspace
    command: java -jar /opt/alloy/alloy-cli.jar shirushi.als
    environment:
      - ALLOY_CLI_JAR=/opt/alloy/alloy-cli.jar

# Usage:
#
# Run full verification:
#   docker-compose run --rm verify
#
# Interactive shell:
#   docker-compose run --rm shell
#
# TLA+ only:
#   docker-compose run --rm apalache
#
# Alloy only:
#   docker-compose run --rm alloy
#
# Build images:
#   docker-compose build
